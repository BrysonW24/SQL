
/***************************************
JOINING COMMBIZ ACCOUNT DATA TO GRD GROUP STANDARD ACC_I
--Sandpit table contains CommBiz Service / Account data from OMNIA
--Objective is to convert the CommBiz Account Number from OMNIA to ACCT_I format
--This is achieved by matching individual Product Systems at a time
***************************************/


--A) UNIQUE COMMBIZ ENABLED ACCOUNT LIST
CREATE VOLATILE TABLE VT_ACCT
AS
(
SELECT 
A.ACCOUNT_NUMBER
, A.PRODUCT_CODE
, A.SALES_PRODUCT_CODE
, A.ACCOUNT_TYPE_DESCRIPTION
FROM U_D_DSV_001_PGR_1.CBZ_SERVICE_ACCOUNT A
GROUP BY 1,2,3,4
) WITH DATA ON COMMIT PRESERVE ROWS;

SELECT * FROM VT_ACCT

--a) JOIN DDA and Line of Credit (LOC) Accounts
--DROP TABLE VT_SAP;
CREATE VOLATILE TABLE VT_SAP
AS
(
SELECT 
A.ACCOUNT_NUMBER
, A.PRODUCT_CODE
, A.SALES_PRODUCT_CODE
, A.ACCOUNT_TYPE_DESCRIPTION
, B.ACCT_I AS SAP_ACCT_I
FROM VT_ACCT A
LEFT JOIN ACCT_BASE B ON A.ACCOUNT_NUMBER=B.SRCE_SYST_ACCT_N AND B.SRCE_SYST_C='SAP'
WHERE A.PRODUCT_CODE IN ('DDA','LOC')
GROUP BY 1,2,3,4,5
) WITH DATA ON COMMIT PRESERVE ROWS;

--313,656
SELECT * FROM VT_SAP
SELECT COUNT(*) FROM VT_SAP
SELECT COUNT(DISTINCT(ACCOUNT_NUMBER)) FROM VT_SAP

--313,656
SELECT COUNT(*) FROM VT_SAP
WHERE SAP_ACCT_I IS NOT NULL


--b) JOIN Card Accounts
--DROP TABLE VT_CCS;
CREATE VOLATILE TABLE VT_CCS
AS
(
SELECT 
A.ACCOUNT_NUMBER
, A.PRODUCT_CODE
, A.SALES_PRODUCT_CODE
, A.ACCOUNT_TYPE_DESCRIPTION
, B.ACCT_I AS CCS_ACCT_I
FROM VT_ACCT A
LEFT JOIN ACCT_BASE B ON A.ACCOUNT_NUMBER=B.SRCE_SYST_ACCT_N AND B.SRCE_SYST_C='CCS'
WHERE A.PRODUCT_CODE IN ('MCB','MCW','MCA','MCP','MCD','MCG','VCD','VSG','VSW','VSP')
GROUP BY 1,2,3,4,5
) WITH DATA ON COMMIT PRESERVE ROWS;


--183,901
SELECT * FROM VT_CCS
SELECT COUNT(*) FROM VT_CCS
SELECT COUNT(DISTINCT(ACCOUNT_NUMBER)) FROM VT_CCS

--183,901
SELECT COUNT(*) FROM VT_CCS
WHERE CCS_ACCT_I IS NOT NULL


--c) JOIN CDA / CRA Accounts (CASh Deposit Accounts / Cash Relationship Accounts / Term Deposits - DMM (Domestic Money Market Accounts)
DROP TABLE VT_CDA;
CREATE VOLATILE TABLE VT_CDA
AS
(
SELECT 
A.ACCOUNT_NUMBER
, A.PRODUCT_CODE
, A.SALES_PRODUCT_CODE
, A.ACCOUNT_TYPE_DESCRIPTION
, B.ACCT_I AS CDA_ACCT_I
FROM VT_ACCT A
LEFT JOIN ACCT_BASE B ON A.ACCOUNT_NUMBER=B.SRCE_SYST_ACCT_N AND B.SRCE_SYST_C IN ('SAP','DMM') AND ACCT_QLFY_C IN ('DM','SP')
WHERE A.PRODUCT_CODE IN ('CDA','CRA')
GROUP BY 1,2,3,4,5
) WITH DATA ON COMMIT PRESERVE ROWS;


--19,106
SELECT * FROM VT_CDA
SELECT COUNT(*) FROM VT_CDA
SELECT COUNT(DISTINCT(ACCOUNT_NUMBER)) FROM VT_CDA

--19,106
SELECT COUNT(*) FROM VT_CDA
WHERE CDA_ACCT_I IS NOT NULL



--D) JOIN LAL Accounts (Market Rate Loans / BBL / Managed Investment Schemes / Super geard etc.) - All covered in SAP
DROP TABLE VT_LAL;
CREATE VOLATILE TABLE VT_LAL
AS
(
SELECT 
A.ACCOUNT_NUMBER
, A.PRODUCT_CODE
, A.SALES_PRODUCT_CODE
, A.ACCOUNT_TYPE_DESCRIPTION
, B.ACCT_I AS LAL_ACCT_I
FROM VT_ACCT A
LEFT JOIN ACCT_BASE B ON A.ACCOUNT_NUMBER=B.SRCE_SYST_ACCT_N AND B.SRCE_SYST_C = 'SAP'
WHERE A.PRODUCT_CODE ='LAL'
GROUP BY 1,2,3,4,5
) WITH DATA ON COMMIT PRESERVE ROWS;

--13,799 Unique Accounts
SELECT * FROM VT_LAL
SELECT COUNT(DISTINCT(ACCOUNT_NUMBER)) FROM U_D_DSV_001_PGR_1.CBZ_SERVICE_ACCOUNT WHERE PRODUCT_CODE='LAL'


--13,799
SELECT COUNT(*) FROM VT_LAL
SELECT COUNT(DISTINCT(ACCOUNT_NUMBER)) FROM VT_LAL

--13,799
SELECT COUNT(*) FROM VT_LAL
WHERE LAL_ACCT_I IS NOT NULL



--E) JOIN AFP / AFA Accounts (Asset Finance Accounts)
DROP TABLE VT_AFP;
CREATE VOLATILE TABLE VT_AFP
AS
(
SELECT 
A.ACCOUNT_NUMBER
, A.PRODUCT_CODE
, A.SALES_PRODUCT_CODE
, A.ACCOUNT_TYPE_DESCRIPTION
, B.ACCT_I AS AFP_ACCT_I
FROM VT_ACCT A
LEFT JOIN ACCT_BASE B ON A.ACCOUNT_NUMBER=B.SRCE_SYST_ACCT_N AND B.SRCE_SYST_C = 'AFS'
WHERE A.PRODUCT_CODE IN ('AFP','AFA')
GROUP BY 1,2,3,4,5
) WITH DATA ON COMMIT PRESERVE ROWS;

--8,823 Unique Accounts
SELECT * FROM VT_AFP
SELECT COUNT(DISTINCT(ACCOUNT_NUMBER)) FROM U_D_DSV_001_PGR_1.CBZ_SERVICE_ACCOUNT WHERE PRODUCT_CODE='AFP'


--8,823
SELECT COUNT(*) FROM VT_AFP
SELECT COUNT(DISTINCT(ACCOUNT_NUMBER)) FROM VT_AFP

--8,823
SELECT COUNT(*) FROM VT_AFP
WHERE AFP_ACCT_I IS NOT NULL





--F) JOIN CLS  Accounts (Contingent Liabilities)
--No Account Join for CLS Accounts

--G) JOIN OFI Accounts (OFI)
--No Account Join for OFI Accounts

--H) JOIN LBX Accounts (E-Lockbox Accounts)
--No Account Join for LBX Accounts

--I) JOIN FCA Accounts (Foreign Currency Accounts)
--No Account Join for FCA Accounts - New accounts should be in SAP


--J) BRING ALL ACCOUNTS INTO FINAL TABLE
--543,037 unique accounts
DROP TABLE VT_FIN_ACCT;
CREATE VOLATILE TABLE VT_FIN_ACCT
AS
(
SELECT 
A.*
, B.SAP_ACCT_I
, C.CCS_ACCT_I
, D.CDA_ACCT_I
, E.LAL_ACCT_I
, F.AFP_ACCT_I
, COALESCE(SAP_ACCT_I, CCS_ACCT_I, CDA_ACCT_I, LAL_ACCT_I, AFP_ACCT_I) AS ACCT_I
FROM VT_ACCT A
LEFT JOIN VT_SAP B ON A.ACCOUNT_NUMBER=B.ACCOUNT_NUMBER
LEFT JOIN VT_CCS C ON A.ACCOUNT_NUMBER=C.ACCOUNT_NUMBER
LEFT JOIN VT_CDA D ON A.ACCOUNT_NUMBER=D.ACCOUNT_NUMBER
LEFT JOIN VT_LAL E ON A.ACCOUNT_NUMBER=E.ACCOUNT_NUMBER
LEFT JOIN VT_AFP F ON A.ACCOUNT_NUMBER=F.ACCOUNT_NUMBER
) WITH DATA ON COMMIT PRESERVE ROWS;

--VALIDATION
--ONly OFI, CLS, LBX and FCA accounts have NULL Account I
SELECT * FROM VT_FIN_ACCT
WHERE ACCT_I IS NULL
